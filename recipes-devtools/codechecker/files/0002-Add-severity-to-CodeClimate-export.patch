From b0c8eacabe9b26b8882400adbc7ef98d75dd3f10 Mon Sep 17 00:00:00 2001
From: Jarno Malmari <jmalmari@github>
Date: Fri, 11 Jun 2021 21:29:40 +0300
Subject: [PATCH] Add severity to CodeClimate export

Upstream-Status: Accepted [https://github.com/Ericsson/codechecker/pull/3356]

---
 analyzer/codechecker_analyzer/cmd/parse.py     |  2 +-
 .../test_analyze_and_parse.py                  |  1 +
 codechecker_common/output/codeclimate.py       | 18 +++++++++++++++---
 .../codechecker_client/cmd_line_client.py      |  2 +-
 .../test_diff_local_remote.py                  |  1 +
 5 files changed, 19 insertions(+), 5 deletions(-)

diff --git a/analyzer/codechecker_analyzer/cmd/parse.py b/analyzer/codechecker_analyzer/cmd/parse.py
index 57884e74..c2864c04 100644
--- a/analyzer/codechecker_analyzer/cmd/parse.py
+++ b/analyzer/codechecker_analyzer/cmd/parse.py
@@ -624,7 +624,7 @@ def parse_convert_reports(input_dirs: List[str],
             report.trim_path_prefixes(trim_path_prefixes)

     if out_format == "codeclimate":
-        return codeclimate.convert(all_reports)
+        return codeclimate.convert(all_reports, severity_map)

     if out_format == "gerrit":
         return gerrit.convert(all_reports, severity_map)
diff --git a/analyzer/tests/functional/analyze_and_parse/test_analyze_and_parse.py b/analyzer/tests/functional/analyze_and_parse/test_analyze_and_parse.py
index 4060d509..4cfe7922 100644
--- a/analyzer/tests/functional/analyze_and_parse/test_analyze_and_parse.py
+++ b/analyzer/tests/functional/analyze_and_parse/test_analyze_and_parse.py
@@ -271,6 +271,7 @@ class AnalyzeParseTestCase(
             'description': 'Duplicate code detected',
             'categories': ['Bug Risk'],
             'fingerprint': '3d15184f38c5fa57e479b744fe3f5035',
+            'severity': 'minor',
             'location': {
                 'path': 'notes.cpp',
                 'lines': {
diff --git a/codechecker_common/output/codeclimate.py b/codechecker_common/output/codeclimate.py
index c84cf474..305e9515 100644
--- a/codechecker_common/output/codeclimate.py
+++ b/codechecker_common/output/codeclimate.py
@@ -12,7 +12,7 @@ from typing import Dict, List
 from codechecker_common.report import Report


-def convert(reports: List[Report]) -> Dict:
+def convert(reports: List[Report], severity_map: Dict[str, str]) -> Dict:
     """Convert the given reports to codeclimate format.

     This function will convert the given report to Code Climate format.
@@ -22,11 +22,21 @@ def convert(reports: List[Report]) -> Dict:
     """
     codeclimate_reports = []
     for report in reports:
-        codeclimate_reports.append(__to_codeclimate(report))
+        codeclimate_reports.append(__to_codeclimate(report, severity_map))
     return codeclimate_reports


-def __to_codeclimate(report: Report) -> Dict:
+__codeclimate_severity_map = {
+    'CRITICAL': 'critical',
+    'HIGH': 'major',
+    'MEDIUM': 'minor',
+    'LOW': 'minor',
+    'STYLE': 'info',
+    'UNSPECIFIED': 'info',
+}
+
+
+def __to_codeclimate(report: Report, severity_map: Dict[str, str]) -> Dict:
     """Convert a Report to Code Climate format."""
     return {
         "type": "issue",
@@ -34,6 +44,8 @@ def __to_codeclimate(report: Report) -> Dict:
         "description": report.description,
         "categories": ["Bug Risk"],
         "fingerprint": report.report_hash,
+        "severity": __codeclimate_severity_map.get(
+            severity_map.get(report.check_name, 'UNSPECIFIED'), 'info'),
         "location": {
             "path": report.file_path,
             "lines": {
diff --git a/web/client/codechecker_client/cmd_line_client.py b/web/client/codechecker_client/cmd_line_client.py
index 4c7e81d7..d6311174 100644
--- a/web/client/codechecker_client/cmd_line_client.py
+++ b/web/client/codechecker_client/cmd_line_client.py
@@ -1224,7 +1224,7 @@ def handle_diff_results(args):
             output_formats.remove('gerrit')

         if 'codeclimate' in output_formats:
-            cc_reports = codeclimate.convert(reports)
+            cc_reports = codeclimate.convert(reports, context.severity_map)
             # Codelimate was the only format specified.
             if selected_output_format_num == 1 and not output_dir:
                 print(json.dumps(cc_reports))
diff --git a/web/tests/functional/diff_local_remote/test_diff_local_remote.py b/web/tests/functional/diff_local_remote/test_diff_local_remote.py
index 6f73a435..7078ca4d 100644
--- a/web/tests/functional/diff_local_remote/test_diff_local_remote.py
+++ b/web/tests/functional/diff_local_remote/test_diff_local_remote.py
@@ -478,6 +478,7 @@ class LocalRemote(unittest.TestCase):
                 "Bug Risk"
             ],
             "fingerprint": "c2132f78ef0e01bdb5eacf616048625f",
+            "severity": "minor",
             "location": {
                 "path": "new_delete.cpp",
                 "lines": {
--
2.25.1

